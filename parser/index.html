<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>Bootstrap 101 Template</title>

    <!-- Bootstrap -->
    <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="css/icon.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
	
	<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
	
	<!-- http://jsfiddle.net/jcosnn6u/3/ -->
	<link rel="stylesheet" href="http://code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
	<script src="http://code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="bootstrap/js/bootstrap.min.js"></script>
	
	<!-- https://select2.github.io/ -->
	<link href="js/select2/dist/css/select2.min.css" rel="stylesheet" />
	<script src="js/select2/dist/js/select2.min.js"></script>

	<!-- http://www.listjs.com/ -->
	<script type="text/javascript" src="js/list.js"></script>

	<!-- https://github.com/finom/vanillatree -->
	<link href="js/vanillatree/vanillatree.css" rel="stylesheet" />
	<script src="js/vanillatree/vanillatree.js"></script>
	
	<link  href="datepicker/css/bootstrap-datetimepicker.min.css" rel="stylesheet">
	<script src="datepicker/js/bootstrap-datetimepicker.min.js"></script>
	<script src="js/mithril.js"></script>

<script>
/*
//http://javascript.ru/forum/dom-window/21288-nuzhna-pomoshh-s-ochen-prostymi-veshhami-3.html
jQuery.ajax = function (d) {
    var b = location.protocol,
        e = RegExp(b + "//" + location.hostname),
        f = "http" + (/^https/.test(b) ? "s" : "") + "://query.yahooapis.com/v1/public/yql?callback=?";
    return function (a) {
        var c = a.url;
        if (/get/i.test(a.type) && !/json/i.test(a.dataType) && !e.test(c) && /:\/\//.test(c)) {
            a.url = f;
            a.dataType = "json";
            a.data = {
                q: 'select * from html where url="{URL}" and xpath="*"'.replace("{URL}", c + (a.data ? (/\?/.test(c) ? "&" : "?") + jQuery.param(a.data) : "")),
                format: "xml"
            };
            !a.success && a.complete && (a.success = a.complete, delete a.complete);
            var b = a.success;
            a.success = function (a) {
                b && b.call(this, {
                    responseText: (a.results[0] || "").replace(/<script[^>]+?\/>|<script(.|\s)*?\/script>/gi, "")
                }, "success")
            }
        }
        return d.apply(this, arguments)
    }
}(jQuery.ajax);
*/

function addScript(el,url,param){
	param = param || "";
	var script = el.createElement("script");
	script.src = url+'/'+param;
	script.async = true;
	el.getElementsByTagName("head")[0].appendChild(script);
};

var jsonp_set_html = function(data) {
	_PARSE.golink = false;
	var html = populateIframe('html', data.res);
	setEvenHoveredAll(html);
	removeClass(document.querySelector('#golink'),'active');
	Loading.close();
};
	
function request(url,callback) {
	Loading.show();
	callback = callback||null;
	if(callback === null){
		callback = function(res) {
			_PARSE.golink = false;
			var html = populateIframe('html', res.responseText);
			setEvenHoveredAll(html);
			removeClass(document.querySelector('#golink'),'active');
			Loading.close();
		};
	}
	/*
	$.ajax({
		url: url,
		type: 'GET',
		success: callback
	});
	*/
	url = encodeURIComponent(url);
	addScript(document,'https://peaceful-retreat-5894.herokuapp.com/get-content','?url='+url+'&jsonp_callback=jsonp_set_html');

}	

</script>

<style>
#htmltree-content {
	margin-bottom: 10px;
	border: 1px solid #DDDDDD;
	overflow: auto;
	height: 69%;
	width: 98%;
}

#htmltree-content ul {
	list-style: none;
}

#htmltree-content .plus {
	margin-right: 5px;
}

#htmltree-content li {
	cursor: pointer;
}

#htmltree-content .selected {
	background: black;
	color: white;
}

</style>
  </head>
  <body>

<div id="main">
	<div id="header">
	<div class="container-fluid">
		<div id="userinfo">
			<!--prio@hotbox.ru&nbsp;&nbsp;|&nbsp;&nbsp;<a target="_blank" href="#/ru/docs">Документация</a>&nbsp;&nbsp;|&nbsp;&nbsp;<a href="#/ru/site/logout">Выход</a>	-->	
		</div>
		<div id="logo">
			<a href="/">
				<h1>Parser</h1>
			</a>
		</div>
	</div>	
	</div><!-- header -->
</div>	
<div class="clear"></div>
	

<!-- PARSER LIST -->
<template id="js_parse_list" style="display:none">
				<div class="">
					<div class="right-panel">
						<a href="#/parse/create"   class="btn btn-primary btn-lg" title="Create"><i class="icon-plus"></i>&nbsp;Создать парсер</a>
					</div>
				</div>
				<div class="clear"></div>
				<div class="">
					<div class="span2">
						<div class="right-panel hint">
							Это список ваших парсеров.		
						</div>	
					</div>
				</div>	
				<div class="clear"></div>
				<div class="title">Sites</div>
				<br>
				<div id="parser_list" class="grid-view">
					<input type="text" class="search" placeholder="Search" />
					<ul class="head_list">
							<li class="">
								<span class="sort col_5" data-sort="name" id="yw0_c1"><a >id<span class="caret"></span></a></span>
								<span class="sort col_5" data-sort="name" id="yw0_c1"><a >Название сайта<span class="caret"></span></a></span>
								<span class="sort col_5" data-sort="url"  id="yw0_c2"><a >URL сайта<span class="caret"></span></a></span>
								<span class="sort col_5" data-sort="date_edit" id="yw0_c3"><a>Изменено<span class="caret"></span></a></span>
								<span class="button-column col_5" id="yw0_c4"> </span>
							</li>
					</ul>
					<ul class="list"></ul>
				</div>
<script>
  
</script>					
</template>
<!-- PARSER LIST -->


<!-- EDIT PARSE -->
<template id="js_parse_edit" style="display:none">
	<div class="">
		<div class="">
					<div class="">
						<h3>Edit <span class="js_parse_name"></span></h3>
					</div>
					<div class="" style="max-height:80%;">
									
<div class="tabbable tabs-right">
		
		<div class="">
			<div id="" class="tab-pane active">
				<form class="form-inline">
					<div class="form-group">
							<input type="checkbox" name="base" id="js_base_btn">BaseTag
					</div>
				</form>
				
				<div id="panel">
					<div class="_form-inline" style="float:left; margin-right:30px;">
						<input type="text" name="url" class="js_url" value="" placeholder="Введите url страницы" style="width: 300px;"/>
						<button class="btn js_loadpage_nourl" title="Обновить страницу"><i class="icon-repeat"></i></button>
					</div>
					<div class="btn-toolbar">
						<div class="btn-group" data-toggle="buttons-radio">
							<button id="golink" class="btn"><i class="icon-share-alt"></i>&nbsp;Загрузить ссылку</button>
							
						</div>
					</div>
				</div>
						
				<div class="clear"></div>
				<div id="iframes">
								
					<iframe id="html" name="html" width="99%" height="350" ></iframe>
					<div id="hovered-element" style="position:relative;" ><div id="hovered-element-info" style="position:absolute;" ></div></div>			
				</div>
				<div class="clear" style="height:40px;"></div>
				<div id="rules-container">
					<div id="" class="js_items" ></div>
				</div>
				<div class="clear"></div>
			</div>
		
		</div>
	</div>
					</div>
				<div class="">
					<button class="btn js_save_rule"  >Сохранить</button>
					<!--	<button id="btnclose" class="btn" >Закрыть</button>
					<!--	<a data-dismiss="modal" id="add-btn" class="btn" href="/create/" >OK</a>    <a data-dismiss="modal" id="cancel-del-btn" class="btn" href="#">Отмена</a> -->
				</div>
		</div>
	</div>
			
</template>				
<!-- EDIT PARSE -->

<!-- EDIT RES -->
<template id="js_parse_res" style="display:none">
		<div id="script-container">			
			<textarea id="script" class="ldt-input js_rule_res" wrap="off" spellcheck="false" style="margin: 0px; width: 1151px;  height: 431px;"></textarea>
		</div>	
		<a href ="#/">ListParser</a><a href =""></a>
</template>
<!-- EDIT RES -->


<!-- CREATE PARSE -->	
<template id="js_parse_create" style="display:none">
	<div class="">
		<div class="">
			<div class="">
				<h3>Создать парсер <span class="js_parse_id"></span></h3>
			</div>
			<div class="">
				<form class="form1 form-vertical" id="form"  method="post"> 
				<div class="form-group">
					<label for="js-name-field" class="required">Название <span class="required">*</span></label>
					<input class="form-control" name="name-field" id="js-name-field" type="text" placeholder="name">
				</div>
				<div class="form-group">
					<label for="js-url-field" class="required">Стартовая страница <span class="required">*</span></label>
					<input class="form-control" name="url-field" id="js-url-field" type="text" placeholder="site.ru">
				</div>
				<br>
				</form>
			</div>
			<div class="">
					<!--	<button type="button" class="btn btn-default" data-dismiss="modal">Close</button> -->
					<button type="button" class="btn btn-primary js_site_save" data-dismiss="modal">Save changes</button>
			</div>
		</div>
	</div>
</template>
<!-- CREATE PARSE-->

<!-- DEL PARSE -->				
<template id="js_parse_delete" style="display:none">
	<div class="">
		<div class="">
				<div class="">
					<h3>Удаление парсера <span class="js_parse_name"></span></h3>
				</div>
				<div class="">
					<input type="hidden" name="scrid" id="js_scrid" value="">
					<p>Вы действительно хотите удалить парсер?</p>
				</div>
				<div class="">
					<!--	<button type="button" class="btn btn-default" data-dismiss="modal">Close</button> -->
					<button type="button" class="btn btn-primary js_site_del" data-dismiss="modal">Save changes</button>
				</div>
		</div>
	</div>
</template>
<!-- DEL PARSE-->	

<!-- MODAL -->
	<!-- ITEM NAME PARSE -->
	<div id="itemNameParseModal" class="modal fade modal-draggable"   tabindex="-1" role="dialog" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<a class="close" data-dismiss="modal">×</a>
				</div>
				<div class="modal-body">
					<form class="form-inline">
						<div class="form-group">
							<label for="exampleInputName1">Name</label>
							<input type="text" id="exampleInputName1" class = "js_name" name="name" placeholder="Jane Doe" />
						</div>
						<div class="form-group">
							<label for="exampleInputName2">Тип</label>
							<select class="form-control type js_type selattr" name="type" id="exampleInputName2">
								<option value=""></option>
								<option value="link">Ссылка</option>
								<option value="text">Текст</option>
								<option value="html">HTML</option>
								<option value="img">Картинка</option>
								<option value="table">table</option>
							</select>
						</div>
						<div class="form-group">
							<label for="exampleInputName3">Parent</label>
							<select class="form-control parent js_parent selattr" id="exampleInputName3" name="parent" style="width:50px;" >
								<option value=""></option>
							</select>
						</div>
						<button class="btn js_set_item" >OK</button>
					</form>
				</div>
			</div>
		</div>
	</div>
	<!-- ITEM NAME PARSE -->
	<!-- LOAD TREE PARSE -->
	<div id="loadTreeParseModal" class="modal fade"   tabindex="-1" role="dialog" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<a class="close" data-dismiss="modal">×</a>
					<h3>Загружаемые страницы</h3>
				</div>
				<div class="modal-body">
								<div id="loadtree-content">
							<ul>
								<li><img class="plus" src="images/icon-opened.gif"/><span>page1</span><br/>
									<ul>
										<li><img class="plus" src="images/icon-opened.gif"/><span class="selected">page1_1</span></li>
										<li><img class="plus" src="images/icon-opened.gif"/><span>page1_2</span></li>
									</ul>
								</li>
								<li><img class="plus" src="images/icon-opened.gif"/><span>page2</span></li>
							</ul>
						</div>
						<div class="popup-btns">
							<button class="btn" onclick="cancelLoadTree();" style="float:right; margin-left:10px;">Отмена</button>
							<button class="btn" onclick="setLoadTree();" style="float:right;">OK</button>
						</div>
				</div>
			</div>
		</div>
	</div>
	<!-- LOAD TREE PARSE -->
	<!-- HTML TREE PARSE -->
	<div id="htmlTreeParseModal" class="js_htmltree modal fade"   tabindex="-1" role="dialog" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<a class="close" data-dismiss="modal">×</a>
					<h3>Дерево html элементов</h3>
				</div>
				<div class="modal-body">
								<div id="htmltree-content">
						</div>
						<!-- <span>XPath</span><input type="text" name="xpath" style="width: 90%; margin-left: 10px;"/>  -->
						<textarea name="xpath" spellcheck="false" style="width: 97%"></textarea>
						<input type="hidden" name="name" />
						<input type="hidden" name="xpath" />
						<div class="popup-btns">
							<button class="btn" onclick="cancelHtmlTree();" style="float:right; margin-left:10px;">Отмена</button>
							<button class="btn js_set_xpath" id="" onclick="setHtmlTree(this);" style="float:right;">OK</button>
							<div id="labels">
								<span id="rulename"></span>&nbsp;&nbsp;&nbsp;&nbsp;
								
								<span class="label" id="text">Текст</span>
								<span class="label" id="link">Ссылка</span>
								<span class="label" id="image">Картинка</span>
								<span class="label" id="regexp">RegExp</span>
								<span class="label" id="htmltype">HTML</span>
								
							</div>
						</div>
				</div>
			</div>
		</div>
	</div>
	<!-- HTML TREE PARSE -->
<!-- MODAL -->


	<div class="clear"></div>
	
		<div class="container-fluid">
				<div id="js_block"></div>
		</div>
	<div class="clear"></div>

	<div id="loader" class="popup2">
		<img src="images/ajax-loader2.gif" />
	</div>
</body>
<script type="text/javascript" src="js/common.js" ></script>
<script>

$(document).ready(function() {

	$(".datetimepicker" ).datetimepicker({ language: 'ru'});
	
	$(".modal-draggable .modal-dialog").draggable({
		handle: ".modal-header"
	});
	
	
	$(".js_type").select2({
		templateResult: formatState,
		placeholder: "Select a type",
		minimumResultsForSearch: Infinity
	});
});



/**RUN PARSER**/
$('.js_btnrun').on('click',function(e){
	e.preventDefault();
	$(this).hide();
	$('.js_btnstop').show();
	console.log('dont work');
});
$('.js_btnstop').on('click',function(e){
	e.preventDefault();
	$(this).hide();
	$('.js_btnrun').show();
	console.log('dont work');
});
/**RUN PARSER**/



/**RESULT PARSE**/
$('.js_res_save').on('click',function(e){
	e.preventDefault();
	console.log('dont work');
});
$('.js_res_del').on('click',function(e){
	e.preventDefault();
	console.log('dont work');
});

/**RESULT PARSE**/





_PARSE.sites.push({'id':'1', 'name':'habrahabr.ru','url':'http://habrahabr.ru/','date_edit':'22.05.2015'});
_PARSE.sites.push({'id':'2', 'name':'test','url':'http://test.te','date_edit':'22.05.2015'});


function addSiteData(data){
	_PARSE.sites.push(data);	
}

function removeSiteData(id){
	var arr = [];
	for(var i in _PARSE.sites){
		if(_PARSE.sites[i]['id'] != id) arr.push(_PARSE.sites[i]);
	}
	_PARSE.sites = arr;
}
function getSiteData(){
	return _PARSE.sites;
};

function getSite(id){
	for(var i in getSiteData()){
		if(getSiteData()[i]['id'] == id) return getSiteData()[i];
	}
	return false;
};

/**PARSE LIST**/
var ParseList = {
	list : null,
	get : function(){
		
	},
	
    controller: function() {
		//alert('fgh');
    },
    view: function() {
        return m("div", {config: ParseList.config}, m.trust(document.querySelector('#js_parse_list').innerHTML));
    },
    config: function(el, isInit, ctx) {
		/*
		var host = document.querySelector('#js_block');
		var template = document.querySelector('#js_parse_list');
		var clone = document.importNode(template.content, true);
		document.querySelector('#js-block').appendChild(clone);	
		*/	
		var initParseList = function (){
				//http://www.listjs.com/examples/add-get-remove
				var ParseOptions = {
					valueNames: ['id','name', 'url', 'date_edit' ],
					item: '<li class="">'+
									'<span class="id col_5" id="yw0_c1"><a><span class="caret"></span></a></span>'+
									'<span class="name col_5" id="yw0_c1"><a><span class="caret"></span></a></span>'+
									'<span class="url col_5" id="yw0_c2"><a><span class="caret"></span></a></span>'+
									'<span class="date_edit col_5" id="yw0_c3"><a><span class="caret"></span></a></span>'+
									'<span class="button-column col_5" id="yw0_c4">'+ 
												'<button style="margin-left: 5px;" class="js_parse_edit edit" title="Редактировать"><i class="icon-edit"></i></button>'+
												'<button style="margin-left: 5px;" class="js_parse_xx xx" title="Генерировать"><i class="icon-file"></i></button>'+
												'<button style="margin-left: 5px;" class="js_parse_xx xx" title="Управление запуском"><i class="icon-play"></i></button>'+
												'<button style="margin-left: 5px;" class="js_parse_res res" title="Результат выполнения"><i class="icon-folder-open"></i></button>'+
												'<button style="margin-left: 5px;" class="js_parse_del del" title="Удалить"><i class="icon-remove"></i></button>'+
									'</span>'+
							'</li>'
				};
				// Init list
				ParseList.list = new List('parser_list', ParseOptions);
				return ParseList.list;
		}
		
		
		function addSiteList(){
			var parser = getSiteData();
			ParseList.list.add(parser);
		}
		initParseList();
		addSiteList();	
			
		function initEven(event,attr){
					var el = event.target || event.srcElement;
					var button = $(el);
					var id = button.parent().parent().parent().find('.id').text();
					var name = button.parent().parent().parent().find('.name').text();
					var url = button.parent().parent().parent().find('.url').text();
					//alert(id);
					m.route("/parse/"+attr+"/"+id);
					var modal = $(this);
					modal.find('#js_scrid').val(id);
					modal.find('span.js_url').text(url);
					modal.find('input.js_url').val(url);
					modal.find('.js_parse_id, .js_parse_name').text(name);	
		}
		


		/*document.querySelector('.js_parse_edit').onclick = function(event){
			initEven(event);
		}*/
		
		var setAction = function(action){
			var elem = document.querySelectorAll('.js_parse_'+action);
			for(var i in elem){
				elem[i].onclick = function(event){
					initEven(event, action);
				}
			}
		};
		var action = ['edit','res','del'];
		for(var k in action){
			setAction(action[k]);
		}
	
    }
};



var ParseEdit = {
    controller: function() {
		
	},
    view: function() {
        return m("div", {config: ParseEdit.config}, m.trust(document.querySelector('#js_parse_edit').innerHTML));
	},
	config : function(el, isInit, ctx){
		var data = getSite(m.route.param("id"));
		$('#js_scrid').val(data.id);
		$('span.js_url').text(data.url);
		$('input.js_url').val(data.url);
		$('.js_parse_id, .js_parse_name').text(data.name);		
		/**EDIT PARSE**/
		$('#js_base_btn').change(function() {
			if($(this).is(":checked")) {
				addBaseTag(getIframeContent('html'), $('input.js_url').val());
				var html = populateIframe('html', getIframeContent('html').body.innerHTML);
				setEvenHoveredAll(html);
			}else{
				delBaseTag(getIframeContent('html'));
				var html = populateIframe('html', getIframeContent('html').body.innerHTML);
				setEvenHoveredAll(html);
			}
		});
		$('.js_loadpage_nourl').on('click',function(e){
			e.preventDefault();
			var url = document.querySelector('input.js_url').value;//_PARSE.url;
			request(url);
			return false;
		});
		
		$('.js_save_rule').on('click',function(e){
			e.preventDefault();
			rulessave();
			var id = m.route.param("id");
			m.route("/parse/res/"+id);
		});
		
		$('#golink').on('click',function(e){
			e.preventDefault();
			_PARSE.golink = true;
		});
		
		$('.js_set_item').on('click', function(e){
			e.preventDefault();
			setItem();
			return false;
		});
		/**EDIT PARSE**/		
	}
};

var ParseRes = {
    controller: function() {},
    view: function() {
		return m("div", {config: ParseRes.config}, m.trust(document.querySelector('#js_parse_res').innerHTML));
	},
	config : function(el, isInit, ctx){
		tabRuleClick();
	}
};

var ParseCreate = {
    controller: function() {},
    view: function() {
		return m("div", {config: ParseCreate.config}, m.trust(document.querySelector('#js_parse_create').innerHTML));
	},
	config : function(el, isInit, ctx){
		/**SAVE PARSER**/
		$('.js_site_save').on('click',function(e){
			e.preventDefault();
			var data = {
				'id' : '3',
				'name': $('#js-name-field').val(),
				'url': $('#js-url-field').val(),
				'date_edit' : new Date().yyyymmdd()
			};	
			addSiteData(data);
			m.route("/");
			
		});
		/**SAVE PARSER**/		
	}
};

var ParseDel = {
    controller: function() {},
    view: function() {
		return m("div", {config: ParseDel.config}, m.trust(document.querySelector('#js_parse_delete').innerHTML));
	},
	config : function(el, isInit, ctx){

		/**DELETE PARSER**/
		
		$('.js_site_del').on('click',function(e){
			e.preventDefault();
			//var itemId = $('#js_scrid').val();
			removeSiteData(m.route.param("id"));
			m.route("/");
		});
		/**DELETE PARSER**/
	}
};

var Dashboard = {
    controller: function() {},
    view: function() {}
};

m.route.mode = "hash";
//m.route.mode = "search";
//go to the default route (home)
m.route(document.querySelector('#js_block'), "/", {
    "/": ParseList,
	"/parse/create" : ParseCreate,
	"/parse/edit/:id" : ParseEdit,
	"/parse/res/:id" : ParseRes,
	"/parse/del/:id" : ParseDel,
    "/dashboard": Dashboard,
});

//re-route to dashboard
//m.route("/dashboard"); // logs "unloading home"
</script>

</html>
